<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Doc Signer</title>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <style>
        /* RESET & BASICS */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: #f3f4f6; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* CONTAINERS */
        /* Added !important to background to prevent Dark Mode from making it black */
        .card { background: white !important; width: 100%; max-width: 600px; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; color: black; }
        h2 { margin: 0 0 10px 0; font-size: 1.1rem; color: #111827; text-align: center; }

        /* UPLOAD STEP */
        .upload-zone { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 40px 20px; text-align: center; background: #f8fafc; cursor: pointer; transition: 0.2s; }
        .upload-zone:active { background: #e2e8f0; border-color: #94a3b8; }
        
        /* SIGNING WORKSPACE - FIXED: Removed 'display:none' */
        #workspace-container { position: relative; width: 100%; overflow: hidden; border: 1px solid #e5e7eb; touch-action: none; background: #ddd; }
        
        /* The Image shown on screen */
        #preview-img { display: block; width: 100%; height: auto; pointer-events: none; user-select: none; }
        
        /* The Canvas where you sign (Absolute on top) */
        #pad-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; }

        /* CONTROLS */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        button { padding: 14px; border: none; border-radius: 8px; font-weight: 600; font-size: 0.95rem; cursor: pointer; width: 100%; }
        .btn-gray { background: #f3f4f6; color: #374151; }
        .btn-blue { background: #3b82f6; color: white; }
        .btn-green { background: #10b981; color: white; grid-column: span 2; margin-top: 5px; }
        
        /* CAMERA & SELFIE */
        #camera-box { display: none; margin-top: 15px; background: black; border-radius: 8px; overflow: hidden; position: relative; }
        video { width: 100%; height: 250px; object-fit: cover; transform: scaleX(-1); display: block; }
        .overlay-text { position: absolute; bottom: 10px; left: 0; width: 100%; text-align: center; color: white; font-size: 0.8rem; opacity: 0.8; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="card" id="step-upload">
        <h2>üìÇ Upload Document</h2>
        <div class="upload-zone" onclick="document.getElementById('file-in').click()">
            <div style="font-size: 2rem; margin-bottom: 5px;">üìÑ</div>
            <strong>Tap to Select Image</strong>
            <div style="font-size: 0.8rem; color: #64748b; margin-top: 5px;">(JPG, PNG, Screenshot)</div>
        </div>
        <input type="file" id="file-in" accept="image/*" hidden onchange="handleFile(this)">
    </div>

    <div class="card hidden" id="step-sign">
        <h2 id="status-txt">‚úçÔ∏è Sign Here</h2>
        
        <div id="workspace-container">
            <img id="preview-img" src="" alt="Document Loading...">
            <canvas id="pad-canvas"></canvas>
        </div>

        <div id="camera-box">
            <video id="video-feed" autoplay playsinline></video>
            <div class="overlay-text">Position face in view</div>
        </div>

        <div class="btn-grid">
            <button class="btn-gray" onclick="clearSign()">Clear</button>
            <button class="btn-blue" onclick="toggleCamera()" id="cam-btn">üì∏ Selfie</button>
            <button class="btn-green" onclick="finishAndDownload()">‚úÖ Finish & Download</button>
        </div>
        
        <p style="text-align:center; font-size:0.75rem; color:#9ca3af; margin-top:10px;">
            Session ID: <span id="session-id">...</span>
        </p>
    </div>

<script>
    // --- VARIABLES ---
    let originalFile = null;  // Keeps the high-res original
    let originalW = 0, originalH = 0;
    let signaturePad;
    let selfieCanvas = null;
    let uniqueId = "ID-" + Math.random().toString(36).substr(2, 9).toUpperCase(); // "ID-X9A2..."

    document.getElementById('session-id').innerText = uniqueId;

    // --- 1. SETUP & UPLOAD ---
    function handleFile(input) {
        if (!input.files[0]) return;
        const file = input.files[0];
        const reader = new FileReader();

        reader.onload = function(e) {
            // Load image into a hidden object to get REAL dimensions
            const img = new Image();
            img.onload = function() {
                originalW = img.width;
                originalH = img.height;
                startSigningUI(e.target.result);
            };
            img.src = e.target.result;
            originalFile = img; 
        };
        reader.readAsDataURL(file);
    }

    function startSigningUI(imgSrc) {
        // Show the signing screen
        document.getElementById('step-upload').classList.add('hidden');
        document.getElementById('step-sign').classList.remove('hidden');

        // Set the image source
        const preview = document.getElementById('preview-img');
        preview.src = imgSrc;
        
        // Wait 100ms for the div to resize to fit the image, then size the canvas
        setTimeout(() => {
            const workspace = document.getElementById('workspace-container');
            const canvas = document.getElementById('pad-canvas');
            
            // Critical: Make canvas exactly the same size as the visible image
            // workspace.offsetWidth gives the pixel width of the box on your phone
            canvas.width = workspace.offsetWidth;
            canvas.height = workspace.offsetHeight; // This will now work because workspace is visible

            // Initialize Pad with THINNER lines for mobile
            signaturePad = new SignaturePad(canvas, {
                minWidth: 1,  
                maxWidth: 2.5, 
                penColor: "blue",
                velocityFilterWeight: 0.7
            });
        }, 200);
    }

    function clearSign() { 
        if(signaturePad) signaturePad.clear(); 
    }

    // --- 2. CAMERA ---
    let streamRef = null;
    function toggleCamera() {
        const box = document.getElementById('camera-box');
        const btn = document.getElementById('cam-btn');

        if (box.style.display === "block") {
            // Capture Photo
            const video = document.getElementById('video-feed');
            const c = document.createElement('canvas');
            c.width = 300; 
            c.height = 300 * (video.videoHeight / video.videoWidth);
            const ctx = c.getContext('2d');
            ctx.translate(c.width, 0); ctx.scale(-1, 1); // Mirror
            ctx.drawImage(video, 0, 0, c.width, c.height);
            
            selfieCanvas = c; // Store photo
            
            // Stop Camera
            streamRef.getTracks().forEach(t => t.stop());
            box.style.display = "none";
            btn.innerText = "‚úÖ Selfie Saved";
            btn.style.background = "#10b981";
        } else {
            // Start Camera
            box.style.display = "block";
            btn.innerText = "‚ö™ Tap to Snap";
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
                .then(s => { 
                    document.getElementById('video-feed').srcObject = s; 
                    streamRef = s;
                })
                .catch(e => alert("Camera denied. Check browser permissions."));
        }
    }

    // --- 3. FINAL PROCESSING (SCALING FIX) ---
    function finishAndDownload() {
        if (!signaturePad || signaturePad.isEmpty()) { alert("Please sign first."); return; }

        document.getElementById('status-txt').innerText = "Processing...";
        
        setTimeout(() => {
            // A. Create HIGH-RES Canvas (Matches original image size)
            const finalC = document.createElement('canvas');
            const ctx = finalC.getContext('2d');
            
            // Add space for footer (35% of width to ensure text fits)
            const footerH = Math.floor(originalW * 0.35); 
            finalC.width = originalW;
            finalC.height = originalH + footerH;

            // B. Draw White BG & Original Image
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, finalC.width, finalC.height);
            ctx.drawImage(originalFile, 0, 0);

            // C. Draw Signature (SCALED UP)
            // We scale the drawing from the mobile screen size to the full image size
            const screenW = document.getElementById('pad-canvas').width;
            const ratio = originalW / screenW; // e.g., Image is 3x bigger than screen
            
            // Draw the signature canvas onto the big canvas
            ctx.drawImage(document.getElementById('pad-canvas'), 0, 0, originalW, originalH);

            // D. Draw Footer Info (Bold & Large)
            const padding = originalW * 0.04;
            let currentY = originalH + padding;
            
            // Background for footer
            ctx.fillStyle = "#f8fafc";
            ctx.fillRect(0, originalH, originalW, footerH);

            // TEXT SETTINGS (Relative to image size)
            const fontSizeBig = Math.floor(originalW * 0.045); // 4.5% of width
            const fontSizeSmall = Math.floor(originalW * 0.030); // 3% of width
            
            ctx.fillStyle = "#0f172a";
            ctx.font = `bold ${fontSizeBig}px sans-serif`;
            ctx.fillText("DIGITAL SIGNATURE CERTIFICATE", padding, currentY + fontSizeBig);
            
            currentY += (fontSizeBig * 1.8);
            ctx.font = `${fontSizeSmall}px monospace`;
            ctx.fillStyle = "#334155";
            
            ctx.fillText(`Date: ${new Date().toLocaleString()}`, padding, currentY);
            currentY += (fontSizeSmall * 1.5);
            ctx.fillText(`Ref ID: ${uniqueId}`, padding, currentY);
            currentY += (fontSizeSmall * 1.5);
            ctx.fillText(`Device Trace: Verified (Client-Side)`, padding, currentY);

            // E. Draw Selfie (Bottom Right)
            if (selfieCanvas) {
                const sW = originalW * 0.25; // Selfie is 25% of width
                const sH = sW * (selfieCanvas.height / selfieCanvas.width);
                const sX = originalW - sW - padding;
                const sY = originalH + padding;
                
                ctx.drawImage(selfieCanvas, sX, sY, sW, sH);
                ctx.strokeStyle = "#cbd5e1";
                ctx.lineWidth = originalW * 0.005;
                ctx.strokeRect(sX, sY, sW, sH);
            }

            // F. Download
            const link = document.createElement('a');
            link.download = `Signed_${uniqueId}.jpg`;
            link.href = finalC.toDataURL("image/jpeg", 0.9); // High Quality JPG
            link.click();
            
            document.getElementById('status-txt').innerText = "‚úÖ Done";
        }, 100);
    }
</script>

</body>
</html>
